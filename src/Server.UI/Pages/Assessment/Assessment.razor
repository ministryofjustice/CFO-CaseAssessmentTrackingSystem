@using Cfo.Cats.Application.Features.Assessments.DTOs
@using Cfo.Cats.Application.Features.Assessments.Queries
@using Cfo.Cats.Domain.Common.Enums
@using Cfo.Cats.Server.UI.Components.Stepper
@using Cfo.Cats.Server.UI.Pages.Participants.Components

@page "/pages/assessment/{Upci}"

@if (_model != null)
{
    
    <RagBar Assessment="_model" />
        
    
    
	<CatsMudStepper @ref="@Stepper" Color="Color.Primary" Variant="Variant.Filled"
					MobileView="false" HeaderBadgeView="HeaderBadgeView.All" HeaderTextView="HeaderTextView.All"
					ActiveStepChanged="@OnStepChange" ShowSkipButton="false">
		<ChildContent>
			<MudForm Model="@_model">
				@*This top-level form is responsible for submission *@
                
                @foreach (var pathway in _model.Pathways)
                {
                    <AssessmentPathway Model="pathway" />
                }
                <AssessmentResultStep Processing="@Processing" SubmissionSuccess="@SubmissionSuccess" />
			</MudForm>
		</ChildContent>
	</CatsMudStepper>
}

@code {
    

	[Parameter]
	public string Upci { get; set; } = string.Empty;

	private Cfo.Cats.Application.Features.Assessments.DTOs.Assessment? _model;

	private CatsMudStepper Stepper { get; set; } = new();

	private int TabsLength => Stepper.Steps.Count();

	//These should be local to result step component in future.
	private bool Processing { get; set; }
	private bool SubmissionSuccess { get; set; } = false;

	protected override async Task OnInitializedAsync()
	{
        if (_model is null)
        {
            var response = await Mediator.Send(new GetAssessment.Query() { ParticipantId = Upci });

            if (response.Succeeded)
            {
                _model = response.Data!;
            }
        }
    }

	private async Task OnStepChange(int step)
	{
		if (step == Stepper.Steps.Count())
		{
			await SubmitAssessment();
		}
	}

	private async Task SubmitAssessment()
	{
		if (Stepper.IsAllStepsCompleted())
        {
            var validator = new AssessmentValidator();
            var result = await validator.ValidateAsync(_model!);

			if (result.IsValid)
			{
				Processing = true;
				await Task.Delay(10000); //Simulates a genuine POST request in UI.
				Processing = false;
			}
			
		}
	}
}
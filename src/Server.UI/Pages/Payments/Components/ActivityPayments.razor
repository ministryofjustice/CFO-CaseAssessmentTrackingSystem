@inherits CatsComponentBase

<style type="text/css">

    .centered {
        text-align: center;
    }

    .mud-table-head th {
        text-align: center;
        font-weight: bold;
    }

</style>

<MudGrid>
    <MudItem xs="12">
        <MudSwitch @bind-Value="DataView" Label="Data View" Color="Color.Info" />
    </MudItem>
    @if (DataView)
    {
        <MudTable Items="@Payments" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info"
                  GroupBy="_groupDefinition"
                  GroupHeaderStyle="background-color:var(--mud-palette-background-gray)"
                  GroupFooterClass="mb-4">
            <HeaderContent>
                <MudTh>Created</MudTh>
                <MudTh>Approved</MudTh>
                <MudTh>Participant Id</MudTh>
                <MudTh>Location</MudTh>
                <MudTh>Type</MudTh>
                <MudTh>Category</MudTh>
                <MudTh>Activity Type</MudTh>
                <MudTh>Payable</MudTh>
            </HeaderContent>
            <GroupHeaderTemplate>
                <MudTh Class="mud-table-cell-custom-group" colspan="8">@context.Key</MudTh>
            </GroupHeaderTemplate>
            <RowTemplate>
                <MudTd DataLabel="Created">@context.CreatedOn</MudTd>
                <MudTd DataLabel="Approved">@context.ActivityApproved.ToShortDateString()</MudTd>
                <MudTd DataLabel="Participant Id">@context.ParticipantId</MudTd>
                <MudTd DataLabel="Participant Id">@context.Location</MudTd>
                <MudTd DataLabel="Participant Id">@context.LocationType</MudTd>
                <MudTd DataLabel="Participant Id">@context.Category</MudTd>
                <MudTd DataLabel="Participant Id">@context.Type</MudTd>
                <MudTd DataLabel="Payable">

                    @if (context.EligibleForPayment)
                    {
                        @("Yes")
                    }
                    else
                    {
                        <MudTooltip Text="@context.IneligibilityReason">
                            No
                        </MudTooltip>
                    }


                </MudTd>
            </RowTemplate>
        </MudTable>
    }
    else
    {
     
        <MudItem xs="12">
            <MudTable Items="@SummaryData" 
                      Hover="true" 
                      Breakpoint="Breakpoint.Sm" 
                      Loading="_loading" 
                      LoadingProgressColor="Color.Info"
                      Striped="true"
                      Bordered="true"
                      HeaderClass="table-head-bordered"
                      CustomHeader="true">
                <HeaderContent>
                    <MudTHeadRow>
                        <MudTh>

                        </MudTh>
                        <MudTh colspan="3">
                            @ActivityType.SupportWork.Name
                        </MudTh>
                        <MudTh colspan="3">
                            @ActivityType.HumanCitizenship.Name
                        </MudTh>
                        <MudTh colspan="3">
                            @ActivityType.CommunityAndSocial.Name
                        </MudTh>
                        <MudTh colspan="3">
                            @ActivityType.InterventionsAndServicesWraparoundSupport.Name
                        </MudTh>
                    </MudTHeadRow>
                    <MudTHeadRow>
                        <MudTh>
                            Contract
                        </MudTh>
                        <MudTh>Ach</MudTh>
                        <MudTh>Tgt</MudTh>
                        <MudTh>%</MudTh>
                        <MudTh>Ach</MudTh>
                        <MudTh>Tgt</MudTh>
                        <MudTh>%</MudTh>
                        <MudTh>Ach</MudTh>
                        <MudTh>Tgt</MudTh>
                        <MudTh>%</MudTh>
                        <MudTh>Ach</MudTh>
                        <MudTh>Tgt</MudTh>
                        <MudTh>%</MudTh>
                    </MudTHeadRow>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Contract">@context.Contract</MudTd>
                    <MudTd Class="centered">@context.SupportWork</MudTd>
                    <MudTd Class="centered">@context.SupportWorkTarget</MudTd>
                    <MudTd Class="centered">@context.SupportWorkPercentage</MudTd>
                    <MudTd Class="centered">@context.HumanCitizenship</MudTd>
                    <MudTd Class="centered">@context.HumanCitizenshipTarget</MudTd>
                    <MudTd Class="centered">@context.HumanCitizenshipPercentage</MudTd>
                    <MudTd Class="centered">@context.CommunityAndSocial</MudTd>
                    <MudTd Class="centered">@context.CommunityAndSocialTarget</MudTd>
                    <MudTd Class="centered">@context.CommunityAndSocialPercentage</MudTd>
                    <MudTd Class="centered">@context.ISWSupport</MudTd>
                    <MudTd Class="centered">@context.ISWSupportTarget</MudTd>
                    <MudTd Class="centered">@context.ISWSupportPercentage</MudTd>
                </RowTemplate>
            </MudTable>    
        </MudItem>
           <MudItem xs="12" md="6">
             <ApexChart TItem="SummaryDataModel"
                       Title="Activities By Contract">
                <ApexPointSeries TItem="SummaryDataModel"
                                 Items="SummaryData"
                                 Name="@ActivityType.SupportWork.Name"
                                 SeriesType="SeriesType.Bar"
                                 XValue="e => e.Contract"
                                 YValue="e => e.SupportWork"
                                  />
                <ApexPointSeries TItem="SummaryDataModel"
                                 Items="SummaryData"
                                 Name="@ActivityType.HumanCitizenship.Name"
                                 SeriesType="SeriesType.Bar"
                                 XValue="e => e.Contract"
                                 YValue="e => e.HumanCitizenship"
                              />
                <ApexPointSeries TItem="SummaryDataModel"
                                 Items="SummaryData"
                                 Name="@ActivityType.CommunityAndSocial.Name"
                                 SeriesType="SeriesType.Bar"
                                 XValue="e => e.Contract"
                                 YValue="e => e.CommunityAndSocial"
                                 />
                <ApexPointSeries TItem="SummaryDataModel"
                                 Items="SummaryData"
                                 Name="@ActivityType.InterventionsAndServicesWraparoundSupport.Name"
                                 SeriesType="SeriesType.Bar"
                                 XValue="e => e.Contract"
                                 YValue="e => e.ISWSupport"
                                 />
            </ApexChart> 
        </MudItem>
    }
</MudGrid>




@code {
    private readonly ApexChartOptions<SummaryDataModel> _options = new();

    private bool _loading = true;

    private bool DataView { get; set; }
    
    [Parameter]
    public int Month { get; set; }

    [Parameter]
    public int Year { get; set; }

    [Parameter]
    public ContractDto? Contract { get; set; }

    [CascadingParameter] 
    public UserProfile CurrentUser { get; set; } = default!;

    private RawData[] Payments { get; set; } = [];

    private TableGroupDefinition<RawData> _groupDefinition = new()
    {
        GroupName = "Contract",
        Indentation = false,
        Expandable = true,
        Selector = (e) => e.Contract
    };

    protected override async Task OnInitializedAsync()
    {
        var unitOfWork = GetNewUnitOfWork();

        var query = from ep in unitOfWork.DbContext.ActivityPayments
                    join dd in unitOfWork.DbContext.DateDimensions on ep.ActivityApproved equals dd.TheDate
                    join c in unitOfWork.DbContext.Contracts on ep.ContractId equals c.Id
                    join l in unitOfWork.DbContext.Locations on ep.LocationId equals l.Id
                    where dd.TheMonth == Month && dd.TheYear == Year
                    select new
                    {
                        ep.CreatedOn,
                        ep.ActivityApproved,
                        ep.ParticipantId,
                        ep.EligibleForPayment,
                        ep.ActivityCategory,
                        ep.ActivityType,
                        Contract = c.Description,
                        ContractId = c.Id,
                        ep.LocationType,
                        Location = l.Name,
                        ep.IneligibilityReason,
                        TenantId = c!.Tenant!.Id!
                    };

        query = Contract is null 
            ? query.Where(q => q.TenantId.StartsWith(CurrentUser.TenantId!)) 
            : query.Where(q => q.ContractId == Contract.Id);


        Payments = await query.AsNoTracking()
            .Select(x => new RawData 
                { 
                    CreatedOn = x.CreatedOn,
                    ActivityApproved = x.ActivityApproved,
                    ParticipantId = x.ParticipantId,
                    EligibleForPayment = x.EligibleForPayment,
                    Contract = x.Contract,
                    Category = x.ActivityCategory,
                    Type = x.ActivityType,
                    Location = x.Location,
                    LocationType = x.LocationType,
                    IneligibilityReason = x.IneligibilityReason
                })
            .OrderBy(e => e.Contract)
            .ThenByDescending(e => e.CreatedOn)
            .ToArrayAsync();

        this.SummaryData = Payments
            .Where(e => e.EligibleForPayment)
            .GroupBy(e => e.Contract)
            .Select(x => new SummaryDataModel
                {
                    Contract = x.Key,
                    SupportWork = x.Count(g => g.Type == ActivityType.SupportWork.Name),
                    SupportWorkTarget = TargetProvider.GetTarget(x.Key, Month, Year).SupportWork,
                    CommunityAndSocial = x.Count(g => g.Type == ActivityType.CommunityAndSocial.Name),
                    CommunityAndSocialTarget = TargetProvider.GetTarget(x.Key, Month, Year).CommunityAndSocial,
                    HumanCitizenship = x.Count(g => g.Type == ActivityType.HumanCitizenship.Name),
                    HumanCitizenshipTarget = TargetProvider.GetTarget(x.Key, Month, Year).HumanCitizenship,
                    ISWSupport = x.Count(g => g.Type == ActivityType.InterventionsAndServicesWraparoundSupport.Name),
                    ISWSupportTarget = TargetProvider.GetTarget(x.Key, Month, Year).Interventions
                })
            .OrderBy(c => c.Contract)
            .ToList();

        _loading = false;

    }

    private List<SummaryDataModel> SummaryData = [];

    private class RawData
    {
        public DateTime CreatedOn { get; set; }
        public DateTime ActivityApproved { get; set; }
        public string Contract { get; set; } = "";
        public string ParticipantId { get; set; } = "";
        public bool EligibleForPayment { get; set; }
        public string Category { get; set; } = "";
        public string Type { get; set; } = "";
        public string LocationType { get; set; } = "";
        public string Location { get; set; } = "";
        public string? IneligibilityReason { get; set; }
    }

    private class SummaryDataModel
    {
        public required string Contract {get; set;}
        public int SupportWork { get; set; }
        public int SupportWorkTarget { get;set; }
        public decimal SupportWorkPercentage => SupportWork.CalculateCappedPercentage(SupportWorkTarget);
        public int CommunityAndSocial { get; set; }
        public int CommunityAndSocialTarget { get;set; }
        public decimal CommunityAndSocialPercentage => CommunityAndSocial.CalculateCappedPercentage(CommunityAndSocialTarget);
        public int HumanCitizenship { get; set; }
        public int HumanCitizenshipTarget { get;set; }
        public decimal HumanCitizenshipPercentage => HumanCitizenship.CalculateCappedPercentage(HumanCitizenshipTarget);
        public int ISWSupport { get; set; }
        public int ISWSupportTarget { get;set; }
        public decimal ISWSupportPercentage => ISWSupport.CalculateCappedPercentage(ISWSupportTarget);
    }

}
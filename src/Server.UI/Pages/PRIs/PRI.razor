@inherits CatsComponentBase

@page "/pages/participants/{Upci}/PRI"

@using Cfo.Cats.Application.Common.Interfaces.Locations
@using Cfo.Cats.Application.Common.Validators
@using Cfo.Cats.Application.Features.Locations.DTOs
@using Cfo.Cats.Application.Features.Locations.Queries.GetAll
@using Cfo.Cats.Application.Features.PRIs.Commands
@using Cfo.Cats.Domain.Common.Enums
@using Cfo.Cats.Server.UI.Components.Stepper

@inject ILocationService LocationService
@inject ICurrentUserService CurrentUserService
@inject IValidator<AddPRI.Command> validator

@if(_model is not null)
{
    <MudContainer Class="d-flex align-center">
        <CatsMudStepper @ref="_stepper" Color="Color.Primary" Variant="Variant.Filled"
        MobileView="false" HeaderBadgeView="HeaderBadgeView.All" HeaderTextView="HeaderTextView.All" 
        Style="width: 100%; max-width: 1024px" ActiveStepChanged="OnStepChange">
            <ChildContent>
                <MudForm Model="_model">
                    <MudCard Class="px-8 pt-4 pb-8">
                        <CatsMudStep Title="Release" Icon="@Icons.Material.Filled.Map" Condition="() => IsValid(_releaseForm)">
                            <ChildContent>
                                <MudForm @ref="_releaseForm" Model="_model.Release" Validation="Validator.ValidateValue(_model.Release)">
                                    <FilterLocationAutoComplete Locations="_custodyLocations" 
                                                                @bind-Value="_model.Release.CustodyLocation"
                                                                Label="Discharge Location"
                                                                For="() => _model.Release.CustodyLocation!" />

                                    <FilterLocationAutoComplete Locations="_communityLocations" 
                                                                @bind-Value="_model.Release.ExpectedRegion"
                                                                Label="Expected release region"
                                                                @bind-Value:after="LocationChanged"
                                                                For="() => _model.Release.ExpectedRegion!" />
                                    
                                    <MudDatePicker @bind-Date="_model.Release.ExpectedOn"
                                                   For="() => _model.Release.ExpectedOn"
                                                   Label="Expected date of release"
                                                   MinDate="DateTime.Today"
                                                   MaxDate="DateTime.Today.AddMonths(3)"
                                                   PickerVariant="PickerVariant.Dialog"
                                                   Editable="true"
                                                   Class="mt-2" />
                                </MudForm>
                            </ChildContent>
                        </CatsMudStep>
                        <CatsMudStep Title="Assignment" Icon="@Icons.Material.Filled.Person" Condition="() => IsValid(_codeForm)">
                            <ChildContent>
                                <MudForm @ref="_codeForm" Model="_model.Code" Validation="Validator.ValidateValue(_model.Code)">
                                    @if(_model.Code.IsSelfAssignmentAllowed)
                                    {
                                        <MudAlert Class="mb-4" Severity="Severity.Info">If not self-assigning, the community support worker will need to generate and provide you with a PRI code</MudAlert>
                                    }
                                    else
                                    {
                                        <MudAlert Class="mb-4" Severity="Severity.Warning">Self-assignment is not permitted here as you do not have access to the Expected release region</MudAlert>                              
                                    }

                                    <MudText Typo="Typo.body1">Enter PRI code below</MudText>
                                    <MudTextField @bind-Value="_model.Code.PriCode"
                                    For="() => _model.Code.PriCode"
                                    Label="Code"
                                    MaxLength="6"
                                    Immediate
                                    InputMode="InputMode.numeric"
                                    Disabled="_model.Code.SelfAssign && _model.Code.IsSelfAssignmentAllowed"
                                    Class="mb-2" />
                     
                                    @if(_model.Code.IsSelfAssignmentAllowed)
                                    {
                                        <MudCheckBox @bind-Value="_model.Code.SelfAssign"
                                        @bind-Value:after="() => _model.Code.PriCode = null"
                                        For="() => _model.Code.SelfAssign"
                                        Label="Alternatively, I would like to self-assign the PRI, as I will be working with this participant Through the Gate" />
                                    }
                                </MudForm>
                            </ChildContent>
                        </CatsMudStep>
                        <CatsMudStep Title="Pre-Release Meeting" Icon="@Icons.Material.Filled.MeetingRoom" Condition="() => IsValid(_meetingForm)">
                            <ChildContent>
                                <MudForm @ref="_meetingForm" Model="_model.Meeting" Validation="Validator.ValidateValue(_model.Meeting)">
                                    <MudText Class="mb-1" Typo="Typo.body2">Date pre-release meeting took place between the Custody Support Worker, the Community Support Worker (potentially yourself), and the Participant</MudText>
                                    <MudDatePicker @bind-Date="_model.Meeting.AttendedOn"
                                    For="() => _model.Meeting.AttendedOn"
                                    Label="Date pre-release meeting took place"
                                    MaxDate="DateTime.Today"
                                    Class="mb-6"/>

                                    @* Custody *@
                                    <MudText Typo="Typo.body1">Did the Custody Support Worker attend this meeting in person?</MudText>
                                    <MudToggleGroup @bind-Value="_model.Meeting.CustodyAttendedInPerson" SelectionMode="SelectionMode.SingleSelection" CheckMark>
                                        <MudToggleItem Value="ConfirmationStatus.Yes">@ConfirmationStatus.Yes.Name</MudToggleItem>
                                        <MudToggleItem Value="ConfirmationStatus.No">@ConfirmationStatus.No.Name</MudToggleItem>
                                    </MudToggleGroup>
                                    <MudTextField ReadOnly Underline="false" For="() => _model.Meeting.CustodyAttendedInPerson" hidden />

                                    @if (_model.Meeting.CustodyAttendedInPerson == ConfirmationStatus.No)
                                    {
                                        <MudTextField @bind-Value="_model.Meeting.ReasonCustodyDidNotAttendInPerson"
                                        For="() => _model.Meeting.ReasonCustodyDidNotAttendInPerson"
                                        Label="Reason for not attending the meeting in person"
                                        MaxLength="@ValidationConstants.NotesLength"
                                        Lines="5"
                                        Class="mt-2" />
                                    }

                                    <MudDivider Class="my-6" />

                                    @* Community *@
                                    <MudText Typo="Typo.body1">Did the Community Support Worker attend this meeting in person?</MudText>
                                    <MudToggleGroup @bind-Value="_model.Meeting.CommunityAttendedInPerson" SelectionMode="SelectionMode.SingleSelection" CheckMark>
                                        <MudToggleItem Value="ConfirmationStatus.Yes">@ConfirmationStatus.Yes.Name</MudToggleItem>
                                        <MudToggleItem Value="ConfirmationStatus.No">@ConfirmationStatus.No.Name</MudToggleItem>
                                    </MudToggleGroup>
                                    <MudTextField ReadOnly Underline="false" For="() => _model.Meeting.CommunityAttendedInPerson" hidden />

                                    @if (_model.Meeting.CommunityAttendedInPerson == ConfirmationStatus.No)
                                    {
                                        <MudTextField @bind-Value="_model.Meeting.ReasonCommunityDidNotAttendInPerson"
                                        For="() => _model.Meeting.ReasonCommunityDidNotAttendInPerson"
                                        Label="Reason for not attending the meeting in person"
                                        MaxLength="@ValidationConstants.NotesLength"
                                        Lines="5"
                                        Class="mt-2" />
                                    }

                                    <MudDivider Class="my-6" />

                                    @* Participant *@
                                    <MudText Typo="Typo.body1">Did the Participant attend this meeting in person?</MudText>
                                    <MudToggleGroup @bind-Value="_model.Meeting.ParticipantAttendedInPerson" SelectionMode="SelectionMode.SingleSelection" CheckMark>
                                        <MudToggleItem Value="ConfirmationStatus.Yes">@ConfirmationStatus.Yes.Name</MudToggleItem>
                                        <MudToggleItem Value="ConfirmationStatus.No">@ConfirmationStatus.No.Name</MudToggleItem>
                                    </MudToggleGroup>
                                    <MudTextField ReadOnly Underline="false" For="() => _model.Meeting.ParticipantAttendedInPerson" hidden />

                                    @if (_model.Meeting.ParticipantAttendedInPerson == ConfirmationStatus.No)
                                    {
                                        <MudTextField @bind-Value="_model.Meeting.ReasonParticipantDidNotAttendInPerson"
                                        For="() => _model.Meeting.ReasonParticipantDidNotAttendInPerson"
                                        Label="Reason for not attending the meeting in person"
                                        MaxLength="@ValidationConstants.NotesLength"
                                        Lines="5"
                                        Class="mt-2" />
                                    }
                                    <MudTextField @bind-Value="_model.Meeting.PostReleaseCommunitySupportInformation"
                                                  For="() => _model.Meeting.PostReleaseCommunitySupportInformation"
                                                  Label="Post release community support information"
                                                  MaxLength="@ValidationConstants.NotesLength"
                                                  Lines="5"
                                                  Class="mt-2" />
                                </MudForm>
                            </ChildContent>
                        </CatsMudStep>
                        <StatusResultStep Upci="@Upci" Processing="@Processing" SubmissionSuccess="@SubmissionSuccess" SuccessText="PRI Created" FailureText="PRI failed to submit">
                            <MudText Typo="Typo.body1">A new objective has been automatically created in the Pathway Plan. Please visit the Pathway Plan to add any additional tasks identified in the meeting</MudText>
                        </StatusResultStep>
                    </MudCard>
                </MudForm>
            </ChildContent>
        </CatsMudStepper>
    </MudContainer>
}

@code {
    MudForm _codeForm = new();
    MudForm _releaseForm = new();
    MudForm _meetingForm = new();

    CatsMudStepper _stepper = new();

    AddPRI.Command? _model;

    bool Processing { get; set; }
    bool SubmissionSuccess { get; set; }

    LocationDto[] _communityLocations = [];
    LocationDto[] _custodyLocations = [];

    [CascadingParameter]
    public UserProfile? CurrentUser { get; set; }

    [Parameter, EditorRequired]
    public required string Upci { get; set; }

    [Parameter, EditorRequired]
    public required LocationDto CurrentLocation { get; set; }

    protected override async Task OnInitializedAsync()
    {
        _model = new AddPRI.Command(Upci);

        _communityLocations = await GetNewMediator().Send(new GetAllLocationsQuery()
        {
            LocationType = LocationType.Community
        });

        var all = await GetNewMediator().Send(new GetAllLocationsQuery()
            {
                TenantId = CurrentUser!.TenantId
            });

        _custodyLocations = all.Data!.Where(e => e.LocationType.IsCustody).ToArray();

        _model.Release.CustodyLocation = CurrentLocation;
    }
    
    private async Task LocationChanged()
    {
        if(_model is { Release.ExpectedRegion: not null} )
        {
            // Allow self assignment if user has access to expected release region
            _model.Code.IsSelfAssignmentAllowed = LocationService
                .GetVisibleLocations(CurrentUserService.TenantId!).Select(l => l.Id)
                .Contains(_model.Release.ExpectedRegion.Id);
        }
        else
        {
            _model!.Code.IsSelfAssignmentAllowed = false;
        }

        // Present warning if chosen location is different to the location DMS believes they are transferring to
        await Task.CompletedTask;
    }

    private async Task SubmitPri()
    {
        if (_stepper.IsAllStepsCompleted())
        {
            var result = await validator.ValidateAsync(_model!);

            if (result.IsValid)
            {
                Processing = true;
                var response = await GetNewMediator().Send(_model!);
                Processing = false;
                SubmissionSuccess = response.Succeeded;
            }
            else
            {
                Snackbar.Add(string.Join(", ", result.Errors), Severity.Error);
            }
        }
    }

    private async Task OnStepChange(int step)
    {
        try
        {
            Processing = true;

            if (step == _stepper.Steps.Count())
            {
                await SubmitPri();
            }
        }
        finally
        {
            Processing = false;
        }
    }

    async Task<bool> IsValid(MudForm form)
    {
        await form.Validate();
        return form.IsValid;
    }
}

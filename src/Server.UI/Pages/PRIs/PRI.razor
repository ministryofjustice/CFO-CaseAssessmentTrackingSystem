@inherits CatsComponentBase

@page "/pages/participants/{Upci}/PRI"

@using Cfo.Cats.Application.Common.Interfaces.Locations
@using Cfo.Cats.Application.Common.Validators
@using Cfo.Cats.Application.Features.Locations.DTOs
@using Cfo.Cats.Application.Features.Locations.Queries.GetAll
@using Cfo.Cats.Application.Features.PRIs.Commands
@using Cfo.Cats.Domain.Common.Enums
@using Cfo.Cats.Server.UI.Components.Stepper

@if(model is not null)
{
    <MudContainer Class="d-flex align-center">
        <CatsMudStepper @ref="stepper" Color="Color.Primary" Variant="Variant.Filled"
        MobileView="false" HeaderBadgeView="HeaderBadgeView.All" HeaderTextView="HeaderTextView.All" 
        Style="width: 100%; max-width: 1024px" ActiveStepChanged="OnStepChange">
            <ChildContent>
                <MudForm Model="model">
                    <MudCard Class="px-8 pt-4 pb-8">
                        <CatsMudStep Title="Release" Icon="@Icons.Material.Filled.Map" Condition="() => IsValid(releaseForm)">
                            <ChildContent>
                                <MudForm @ref="releaseForm" Model="model.Release" Validation="Validator.ValidateValue(model.Release)">
                                    <MudSelect @bind-Value="model.Release.ExpectedRegion"
                                    @bind-Value:after="LocationChanged"
                                    Label="Expected release region"
                                    For="() => model.Release.ExpectedRegion"
                                    Clearable="true"
                                    ToStringFunc="location => location?.Name">
                                        @foreach (var location in locations.OrderBy(l => l.Name))
                                        {
                                            <MudSelectItem Value="location">@location.Name</MudSelectItem>
                                        }
                                    </MudSelect>

                                    <MudDatePicker @bind-Date="model.Release.ExpectedOn"
                                    For="() => model.Release.ExpectedOn"
                                    Label="Expected date of release"
                                    MinDate="DateTime.Today"
                                    MaxDate="DateTime.Today.AddMonths(3)"
                                    Class="mt-2" />
                                </MudForm>
                            </ChildContent>
                        </CatsMudStep>
                        <CatsMudStep Title="Assignment" Icon="@Icons.Material.Filled.Person" Condition="() => IsValid(codeForm)">
                            <ChildContent>
                                <MudForm @ref="codeForm" Model="model.Code" Validation="Validator.ValidateValue(model.Code)">
                                    <MudAlert Class="mb-4" Severity="Severity.Info">If not self-assigning, the community support worker will need to generate and provide you with a PRI code</MudAlert>

                                    <MudText Typo="Typo.body1">Already have a PRI Code? Enter it below</MudText>
                                    <MudTextField @bind-Value="model.Code.Value"
                                    For="() => model.Code.Value"
                                    Label="Code"
                                    MaxLength="6"
                                    Immediate
                                    Disabled="model.Code.SelfAssign"
                                    Class="mb-2" />

                                    <MudCheckBox @bind-Value="model.Code.SelfAssign"
                                    @bind-Value:after="() => model.Code.Value = string.Empty"
                                    For="() => model.Code.SelfAssign"
                                    Label="Alternatively, I would like to self-assign the PRI, as I will be working with this participant Through the Gate" />
                                </MudForm>
                            </ChildContent>
                        </CatsMudStep>
                        <CatsMudStep Title="Pre-Release Meeting" Icon="@Icons.Material.Filled.MeetingRoom" Condition="() => IsValid(meetingForm)">
                            <ChildContent>
                                <MudForm @ref="meetingForm" Model="model.Meeting" Validation="Validator.ValidateValue(model.Meeting)">
                                    <MudText Class="mb-1" Typo="Typo.body2">Date pre-release meeting took place between the Custody Support Worker, the Community Support Worker, and the Participant</MudText>
                                    <MudDatePicker @bind-Date="model.Meeting.AttendedOn"
                                    For="() => model.Meeting.AttendedOn"
                                    Label="Date pre-release meeting took place"
                                    MaxDate="DateTime.Today"
                                    Class="mb-6"/>
                                     
                                    @* Custody *@
                                    <MudText Typo="Typo.body1">Did the Custody Support Worker attend this meeting in person?</MudText>
                                    <MudToggleGroup @bind-Value="model.Meeting.CustodyAttendedInPerson" SelectionMode="SelectionMode.SingleSelection" CheckMark>
                                        <MudToggleItem Value="ConfirmationStatus.Yes">@ConfirmationStatus.Yes.Name</MudToggleItem>
                                        <MudToggleItem Value="ConfirmationStatus.No">@ConfirmationStatus.No.Name</MudToggleItem>
                                    </MudToggleGroup>
                                    <MudTextField ReadOnly Underline="false" For="() => model.Meeting.CustodyAttendedInPerson" hidden />

                                    @if (model.Meeting.CustodyAttendedInPerson == ConfirmationStatus.No)
                                    {
                                        <MudTextField @bind-Value="model.Meeting.ReasonCustodyDidNotAttendInPerson"
                                                For="() => model.Meeting.ReasonCustodyDidNotAttendInPerson"
                                                Label="Reason for not attending the meeting in person"
                                                MaxLength="@ValidationConstants.NotesLength"
                                                Lines="5"
                                                Class="mt-2" />
                                    }

                                    <MudDivider Class="my-6" />

                                    @* Community *@
                                    <MudText Typo="Typo.body1">Did the Community Support Worker attend this meeting in person?</MudText>
                                    <MudToggleGroup @bind-Value="model.Meeting.CommunityAttendedInPerson" SelectionMode="SelectionMode.SingleSelection" CheckMark>
                                        <MudToggleItem Value="ConfirmationStatus.Yes">@ConfirmationStatus.Yes.Name</MudToggleItem>
                                        <MudToggleItem Value="ConfirmationStatus.No">@ConfirmationStatus.No.Name</MudToggleItem>
                                    </MudToggleGroup>
                                    <MudTextField ReadOnly Underline="false" For="() => model.Meeting.CommunityAttendedInPerson" hidden />

                                    @if (model.Meeting.CommunityAttendedInPerson == ConfirmationStatus.No)
                                    {
                                        <MudTextField @bind-Value="model.Meeting.ReasonCommunityDidNotAttendInPerson"
                                                      For="() => model.Meeting.ReasonCommunityDidNotAttendInPerson"
                                                      Label="Reason for not attending the meeting in person"
                                                      MaxLength="@ValidationConstants.NotesLength"
                                                      Lines="5"
                                                      Class="mt-2" />
                                    }

                                    <MudDivider Class="my-6" />

                                    @* Participant *@
                                    <MudText Typo="Typo.body1">Did the Participant attend this meeting in person?</MudText>
                                    <MudToggleGroup @bind-Value="model.Meeting.ParticipantAttendedInPerson" SelectionMode="SelectionMode.SingleSelection" CheckMark>
                                        <MudToggleItem Value="ConfirmationStatus.Yes">@ConfirmationStatus.Yes.Name</MudToggleItem>
                                        <MudToggleItem Value="ConfirmationStatus.No">@ConfirmationStatus.No.Name</MudToggleItem>
                                    </MudToggleGroup>
                                    <MudTextField ReadOnly Underline="false" For="() => model.Meeting.ParticipantAttendedInPerson" hidden />

                                    @if (model.Meeting.ParticipantAttendedInPerson == ConfirmationStatus.No)
                                    {
                                        <MudTextField @bind-Value="model.Meeting.ReasonParticipantDidNotAttendInPerson"
                                                      For="() => model.Meeting.ReasonParticipantDidNotAttendInPerson"
                                                      Label="Reason for not attending the meeting in person"
                                                      MaxLength="@ValidationConstants.NotesLength"
                                                      Lines="5"
                                                      Class="mt-2" />
                                    }
                                </MudForm>
                            </ChildContent>
                        </CatsMudStep>
                        <StatusResultStep Upci="@Upci" Processing="@Processing" SubmissionSuccess="@SubmissionSuccess" SuccessText="PRI Created" FailureText="PRI failed to submit">
                            <MudText Typo="Typo.body1">A new objective has been automatically created in the Pathway Plan. Please visit the Pathway Plan to add any additional tasks identified in the meeting</MudText>
                        </StatusResultStep>
                    </MudCard>
                </MudForm>
            </ChildContent>
        </CatsMudStepper>
    </MudContainer>
}

@code {
    MudForm codeForm = new();
    MudForm releaseForm = new();
    MudForm meetingForm = new();

    CatsMudStepper stepper = new();

    AddPRI.Command? model;

    bool Processing { get; set; }
    bool SubmissionSuccess { get; set; } = false;

    LocationDto[] locations = [];

    [Parameter, EditorRequired]
    public required string Upci { get; set; }

    protected override async Task OnInitializedAsync()
    {
        model = new AddPRI.Command()
        {
            ParticipantId = Upci
        };

        locations = await GetNewMediator().Send(new GetAllLocationsQuery()
        {
            LocationType = LocationType.Community
        });

        await base.OnInitializedAsync();
    }

    async Task LocationChanged()
    {
        // Present warning if chosen location is different to the location DMS believes they are transferring to
        await Task.CompletedTask;
    }

    async Task SubmitPRI()
    {
        if (stepper.IsAllStepsCompleted())
        {
            var validator = new AddPRI.Validator();
            var result = await validator.ValidateAsync(model!);

            if (result.IsValid)
            {
                Processing = true;
                var response = await GetNewMediator().Send(model!);
                Processing = false;
                SubmissionSuccess = response.Succeeded;
            }
            else
            {
                Snackbar.Add(string.Join(", ", result.Errors), Severity.Error);
            }

        }
    }

    async Task OnStepChange(int step)
    {
        try
        {
            Processing = true;

            if (step == stepper.Steps.Count())
            {
                await SubmitPRI();
            }
        }
        finally
        {
            Processing = false;
        }
    }

    async Task<bool> IsValid(MudForm form)
    {
        await form.Validate().ConfigureAwait(false);
        return form.IsValid;
    }
}

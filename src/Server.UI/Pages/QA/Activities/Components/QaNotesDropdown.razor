@using Cfo.Cats.Application.Features.Activities.DTOs
@using Cfo.Cats.Application.Features.Activities.Queries
@using Cfo.Cats.Application.SecurityConstants
@using Humanizer

@inherits CatsComponentBase

@if (_notes is null)
{
    <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
}
else if (_notes.Length == 0)
{
    <MudText Typo="Typo.caption" Class="pa-2">No notes found.</MudText>
}
else
{
    <MudText Typo="Typo.body1">
        Notes
    </MudText>
    <MudList T="ActivityQaNoteDto" Dense="true">
        @foreach (var note in _notes.OrderByDescending(n => n.Created))
        {
            <MudListItem Icon="@Icons.Material.Filled.EditNote" Text="Notes" Expanded>
                <MudCard Outlined="false" Elevation="2" Class="mb-2">
                    <MudCardContent>
                        <MudText Typo="Typo.body2">@note.Message</MudText>
                        <MudText Typo="Typo.caption">
                            @(hideUser && CFOTenantNames.Contains(note.TenantName)
                                ? $"CFO User ({note.TenantName}) · {note.Created.Humanize()}"
                                : $"{note.CreatedBy} ({note.TenantName}) · {note.Created.Humanize()}")
                        </MudText>
                    </MudCardContent>
                </MudCard>
            </MudListItem>
        }
    </MudList>
}

@code {
    [Parameter, EditorRequired]
    public Guid? ActivityId { get; set; }

    [CascadingParameter] public UserProfile UserProfile { get; set; } = default!;
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; } = default!;

    private ActivityQaNoteDto[]? _notes;

    private bool hideUser = true;
    private HashSet<string> CFOTenantNames = new() { "CFO", "CFO Evolution" };
    private string[] allowed = { RoleNames.QAOfficer, RoleNames.QASupportManager, RoleNames.QAManager, RoleNames.SMT, RoleNames.SystemSupport };

    protected override async Task OnParametersSetAsync()
    {
        if (ActivityId == null || UserProfile == null || _notes != null)
            return;

        var state = await AuthState;
        bool includeInternalNotes = (await AuthService.AuthorizeAsync(state.User, SecurityPolicies.Internal)).Succeeded;

        var result = await GetNewMediator().Send(new GetActivityQaNotes.Query()
        {
            ActivityId = ActivityId,
            CurentUser = UserProfile,
            IncludeInternalNotes = includeInternalNotes
        });

        if (result.Succeeded)
        {
            _notes = result.Data!.OrderBy(n => n.Created).ToArray();
        }

        if (UserProfile.AssignedRoles.Any(r => allowed.Contains(r)))
            hideUser = false;
    }

}
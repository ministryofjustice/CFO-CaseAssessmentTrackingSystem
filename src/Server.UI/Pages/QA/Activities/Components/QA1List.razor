@using Cfo.Cats.Application.SecurityConstants
@using Cfo.Cats.Application.Features.Activities.DTOs
@using Cfo.Cats.Application.Features.Activities.Queries
@using Humanizer

@inherits CatsComponentBase;

@inject IStringLocalizer<PQA> L

@attribute [Authorize(Policy = SecurityPolicies.Qa1)]

<CascadingValue Value="UserProfile" IsFixed="true">
   
<MudCard style="height: 100%">
    <MudCardHeader>
        <div class="d-flex align-start flex-grow-1">
        <div class="d-flex gap-4">
            <MudIcon Icon="@Icons.Material.Filled.Checklist" Size="Size.Medium" Color="Color.Primary" />
            First Pass
        </div>
        <div class="flex-grow-1"></div>
            <div class="d-flex flex-column justify-end">
                <div class="d-flex">
                    <MudHidden Breakpoint="Breakpoint.SmAndDown">
                        <MudButton Variant="Variant.Outlined"
                                   Size="Size.Small"
                                   Disabled="@_loading"
                                   OnClick="@(() => OnRefresh())"
                                   StartIcon="@Icons.Material.Filled.Refresh" IconColor="Color.Surface" Color="Color.Primary"
                                   Style="margin-right: 4px; margin-bottom:4px">
                            @ConstantString.Refresh
                        </MudButton>
                    </MudHidden>
                    <MudHidden Breakpoint="Breakpoint.SmAndDown" Invert="true">

                    </MudHidden>
                </div>
                <MudTextField T="string" ValueChanged="@(OnSearch)" Value="@Query.Keyword" Placeholder="@ConstantString.Search" Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Small">
                </MudTextField>
            </div>
        </div>
    </MudCardHeader>

    <MudCardContent>
       
        @if (_loading)
        {
            <MudText>@ConstantString.Loading</MudText>
        }
        else if (_pagedData?.Items == null || !_pagedData.Items.Any())
        {
            <MudText>@ConstantString.NoRecords</MudText>
        }
        else
        {
            <div class="d-flex align-center pa-2 mb-1"
                 style="border-radius:6px; font-weight:600; font-size:0.85rem;">

                <div style="width:40px;"></div> @* space for expand button *@

                <div style="min-width:220px; max-width:40%;">
                    Participant
                </div>

                <div style="min-width:180px; max-width:28%;">
                    Activity
                </div>

                <div style="min-width:140px; max-width:18%;">
                    Support Worker
                </div>
                
                <div style="min-width:160px; max-width:18%;">
                    Tenant
                </div>
     
                <div style="min-width:160px; max-width:18%;">
                    Commenced On
                </div>
                <div style="min-width:160px; max-width:18%;">
                    Submitted
                </div>
                <div style="min-width:160px; max-width:18%;">
                    Expiry
                </div>
                <div style="margin-left:auto; width:40px;">Actions</div> @* actions menu space *@
            </div>

            @foreach (var activity in _pagedData.Items)
            {
                <div class="mb-2">
                    @* Row: small expand button + activity summary in a single horizontal line *@
                    <div class="d-flex align-center pa-2" style="background:transparent; border-radius:6px;">
                        <MudIconButton
                            Icon="@(ExpandedRows.Contains(activity.ActivityId) ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                            Size="Size.Small"
                            Edge="Edge.Start"
                            OnClick="@(() => ToggleRow(activity.ActivityId))"
                            aria-label="Toggle notes"/>

                        <div class="ml-2 flex-grow-1 d-flex align-center" style="gap:12px;">
                            <div style="min-width:220px; max-width:40%;">
                                <MudText Typo="Typo.body2" Class="mb-0">
                                    <strong>@activity.ParticipantName</strong>
                                </MudText>
                                <MudText Typo="Typo.caption" Class="mt-0">
                                    @activity.ParticipantId
                                </MudText>
                            </div>

                            <div style="min-width:180px; max-width:28%;">
                                <MudText Typo="Typo.body2" Class="mb-0">
                                    @activity.Activity.Definition.Category.Name
                                </MudText>
                            </div>

                            <div style="min-width:140px; max-width:18%;">
                                <MudText Typo="Typo.body2">@activity.SupportWorker</MudText>
                            </div>

                            <div class="d-flex flex-column">
                                <MudText Typo="Typo.body2">@activity.TenantName</MudText>
                                <MudText Typo="Typo.body2">@activity.TenantId</MudText>
                            </div>
                            <div style="min-width:160px; max-width:18%;">
                                <MudText Typo="Typo.body2">@activity.CommencedOn.Date.ToString("d")</MudText>
                                <MudText Typo="Typo.caption">@activity.CommencedOn.Date.Humanize()</MudText>
                            </div>
                            <div style="min-width:160px; max-width:18%;">
                                <MudText Typo="Typo.body2">@activity.Created.Date.ToString("d")</MudText>
                                <MudText Typo="Typo.caption">@activity.Created.Humanize()</MudText>
                            </div>

                            <div class="d-flex" style="margin-left:auto;">
                                <MudTooltip Text="Must be processed up to 3 months after completion">
                                    @if (@activity.Expiry < DateTime.Today)
                                    {
                                        <MudText Typo="Typo.body2">Expired</MudText>
                                    }
                                    else
                                    {
                                        <div class="d-flex flex-column">
                                            <MudText Typo="Typo.body2">
                                                @activity.Expiry.Date.ToString("d")
                                            </MudText>
                                            <MudText Typo="Typo.body2">
                                                @if (@activity.Expiry == DateTime.Today)
                                                {
                                                    @("Today")
                                                }
                                                else
                                                {
                                                    @activity.Expiry.Humanize()
                                                }
                                            </MudText>
                                        </div>
                                    }
                                </MudTooltip>
                            </div>
                            
                            <div class="d-flex" style="margin-left:auto;">
                                <MudMenu Dense="true" Icon="@Icons.Material.Filled.MoreVert"
                                         AnchorOrigin="Origin.CenterLeft">
                                    <MudMenuItem OnClick="@(() => ViewParticipant(activity))">
                                        @ConstantString.ViewParticipant
                                    </MudMenuItem>
                                </MudMenu>
                            </div>
                        </div>
                    </div>


                    @if (ExpandedRows.Contains(activity.ActivityId))
                    {
                        <MudTr>
                                        <QaNotesDropdown ActivityId="activity.ActivityId" />
                        </MudTr>
                    }
                </div>
            }

            <MudPagination Count="@(_pagedData.TotalItems / _defaultPageSize + 1)"
                           SelectedChanged="OnPaginationChanged"
                           ShowFirstButton="true"
                           ShowLastButton="true"
                           Class="mt-3" />
        }
     
    </MudCardContent>
</MudCard>
</CascadingValue>
@using Cfo.Cats.Application.SecurityConstants
@using Cfo.Cats.Application.Features.Activities.DTOs
@using Cfo.Cats.Application.Features.Activities.Queries
@using Humanizer

@inherits CatsComponentBase;

@inject IStringLocalizer<PQA> L

@attribute [Authorize(Policy = SecurityPolicies.Qa1)]

<CascadingValue Value="UserProfile" IsFixed="true">

<style>
    /* Header and row alignment using flex, no wrap */
    .qa-header, .qa-row {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 0.85rem;
        padding: 8px 12px;
        overflow: hidden;
        flex-wrap: nowrap; /* No wrapping */
    }

    .qa-header {
        border-bottom: 1px solid rgba(0,0,0,0.12);
        background-color: rgba(0,0,0,0.04);
    }

    .qa-row {
        border-radius: 6px;
    }

    /* Columns: flex-grow for shrinking proportionally, min-width for limit */
    .col-expand { flex: 0 0 40px; }
    .col-participant { flex: 1 1 200px; min-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .col-activity { flex: 1 1 180px; min-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .col-worker { flex: 1 1 140px; min-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .col-tenant { flex: 1 1 160px; min-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .col-commenced { flex: 1 1 160px; min-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .col-submitted { flex: 1 1 160px; min-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .col-expiry { flex: 1.5 1 180px; min-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .col-actions { flex: 0 0 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-left: auto; }

    /* Ensure text stays on one line */
    .qa-row div, .qa-header div {
        white-space: nowrap;
    }
</style>

<MudCard style="height: 100%">
    <MudCardHeader>
        <div class="d-flex align-start flex-grow-1">
            <div class="d-flex gap-4">
                <MudIcon Icon="@Icons.Material.Filled.Checklist" Size="Size.Medium" Color="Color.Primary" />
                First Pass
            </div>
            <div class="flex-grow-1"></div>
            <div class="d-flex flex-column justify-end">
                <div class="d-flex">
                    <MudHidden Breakpoint="Breakpoint.SmAndDown">
                        <MudButton Variant="Variant.Outlined"
                                   Size="Size.Small"
                                   Disabled="@_loading"
                                   OnClick="@(() => OnRefresh())"
                                   StartIcon="@Icons.Material.Filled.Refresh"
                                   IconColor="Color.Surface"
                                   Color="Color.Primary"
                                   Style="margin-right: 4px; margin-bottom:4px">
                            @ConstantString.Refresh
                        </MudButton>
                    </MudHidden>
                </div>
                <MudTextField T="string" ValueChanged="@(OnSearch)" Value="@Query.Keyword" Placeholder="@ConstantString.Search"
                              Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Small" />
            </div>
        </div>
    </MudCardHeader>

    <MudCardContent>
        @if (_loading)
        {
            <MudText>@ConstantString.Loading</MudText>
        }
        else if (_pagedData?.Items == null || !_pagedData.Items.Any())
        {
            <MudText>@ConstantString.NoRecords</MudText>
        }
        else
        {
            <!-- Headers -->
            <div class="qa-header">
                <div class="col-expand"></div>
                <div class="col-participant">Participant</div>
                <div class="col-activity">Activity</div>
                <div class="col-worker">Support Worker</div>
                <div class="col-tenant">Tenant</div>
                <div class="col-commenced">Commenced On</div>
                <div class="col-submitted">Submitted</div>
                <div class="col-expiry">Expiry</div>
                <div class="col-actions">Actions</div>
            </div>

            @foreach (var activity in _pagedData.Items)
            {
                <div class="qa-row mb-2">
                    <div class="col-expand">
                        <MudIconButton Icon="@(ExpandedRows.Contains(activity.ActivityId) ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                                       Size="Size.Small"
                                       Edge="Edge.Start"
                                       OnClick="@(() => ToggleRow(activity.ActivityId))"
                                       aria-label="Toggle notes" />
                    </div>

                    <div class="col-participant">
                        <MudText Typo="Typo.body2" Class="mb-0"><strong>@activity.ParticipantName</strong></MudText>
                        <MudText Typo="Typo.caption" Class="mt-0">@activity.ParticipantId</MudText>
                    </div>

                    <div class="col-activity">
                        <MudText Typo="Typo.body2">@activity.Activity.Definition.Category.Name</MudText>
                    </div>

                    <div class="col-worker">
                        <MudText Typo="Typo.body2">@activity.SupportWorker</MudText>
                    </div>

                    <div class="col-tenant">
                        <MudText Typo="Typo.body2">@activity.TenantName</MudText>
                        <MudText Typo="Typo.body2">@activity.TenantId</MudText>
                    </div>

                    <div class="col-commenced">
                        <MudText Typo="Typo.body2">@activity.CommencedOn.Date.ToString("d")</MudText>
                        <MudText Typo="Typo.caption">@activity.CommencedOn.Date.Humanize()</MudText>
                    </div>

                    <div class="col-submitted">
                        <MudText Typo="Typo.body2">@activity.Created.Date.ToString("d")</MudText>
                        <MudText Typo="Typo.caption">@activity.Created.Humanize()</MudText>
                    </div>

                    <div class="col-expiry">
                        <MudTooltip Text="Must be processed up to 3 months after completion">
                            @if (activity.Expiry < DateTime.Today)
                            {
                                <MudText Typo="Typo.body2">Expired</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2">@activity.Expiry.Date.ToString("d")</MudText>
                                <MudText Typo="Typo.body2">@activity.Expiry.Humanize()</MudText>
                            }
                        </MudTooltip>
                    </div>

                    <div class="col-actions">
                        <MudMenu Dense="true" Icon="@Icons.Material.Filled.MoreVert" AnchorOrigin="Origin.CenterLeft">
                            <MudMenuItem OnClick="@(() => ViewParticipant(activity))">@ConstantString.ViewParticipant</MudMenuItem>
                        </MudMenu>
                    </div>
                </div>

                @if (ExpandedRows.Contains(activity.ActivityId))
                {
                    <div class="qa-expand">
                        <QaNotesDropdown ActivityId="activity.ActivityId" />
                    </div>
                }
            }

            <MudPagination Count="@(_pagedData.TotalItems / _defaultPageSize + 1)"
                           SelectedChanged="OnPaginationChanged"
                           ShowFirstButton="true"
                           ShowLastButton="true"
                           Class="mt-3" />
        }
    </MudCardContent>
</MudCard>
</CascadingValue>
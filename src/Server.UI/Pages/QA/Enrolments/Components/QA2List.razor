@using Cfo.Cats.Application.SecurityConstants
@using Humanizer

@inherits CatsComponentBase;

@inject IStringLocalizer<PQA> L

@attribute [Authorize(Policy = SecurityPolicies.Qa2)]

<style>
    .qa-header, .qa-row {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 0.85rem;
        padding: 8px 12px;
        overflow: hidden;
        flex-wrap: nowrap; 
    }

    .qa-header {
        border-bottom: 1px solid rgba(0,0,0,0.12);
        background-color: rgba(0,0,0,0.04);
    }

    .qa-row {
        border-radius: 6px;
    }

    .col-expand { flex: 0 0 40px; }
    .col-participant { flex: 1 1 200px; min-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .col-assignedTo { flex: 1 1 180px; min-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .col-worker { flex: 1 1 140px; min-width: 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .col-tenant { flex: 1 1 160px; min-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .col-commenced { flex: 1 1 160px; min-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .col-submitted { flex: 1 1 160px; min-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .col-actions { flex: 0 0 60px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-left: auto; }

    .qa-row div, .qa-header div {
        white-space: nowrap;
    }

    .qa-pager-row {
        display: flex;
        justify-content: flex-end; 
        align-items: center;
        gap: 12px;
        width: 100%;
        box-sizing: border-box;
    }

    .qa-pager-right {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .qa-page-counter {
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .qa-pager-right,
    .qa-pager-right .mud-pagination ul {
        display: inline-flex !important;
        width: auto !important;
        margin: 0;
        padding: 0;
    }

    .qa-pager-right .mud-pagination button {
        min-width: 36px !important;
        padding: 0 6px !important;
        height: 32px !important;
    }
</style>

<CascadingValue Value="UserProfile" IsFixed="true">
    <MudCard style="height: 100%">
        <MudCardHeader>
            <div class="d-flex align-start flex-grow-1">
                <div class="d-flex gap-4">
                    <MudIcon Icon="@Icons.Material.Filled.Checklist" Size="Size.Medium" Color="Color.Primary" />
                    Second Pass
                </div>
                <div class="flex-grow-1"></div>
                <div class="d-flex flex-column justify-end">
                    <div class="d-flex">
                        <MudHidden Breakpoint="Breakpoint.SmAndDown">
                            <MudButton Variant="Variant.Outlined"
                                       Size="Size.Small"
                                       Disabled="@_loading"
                                       OnClick="@(() => OnRefresh())"
                                       StartIcon="@Icons.Material.Filled.Refresh"
                                       IconColor="Color.Surface"
                                       Color="Color.Primary"
                                       Style="margin-right: 4px; margin-bottom:4px">
                                @ConstantString.Refresh
                            </MudButton>
                        </MudHidden>
                    </div>
                    <MudTextField T="string" ValueChanged="@(OnSearch)" Value="@Query.Keyword" Placeholder="@ConstantString.Search"
                                  Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Small" />
                </div>
            </div>
        </MudCardHeader>
        
        <MudCardContent>
            @if (_loading)
            {
                <MudText>@ConstantString.Loading</MudText>
            }
            else if (_pagedData?.Items == null || !_pagedData.Items.Any())
            {
                <MudText>@ConstantString.NoRecords</MudText>
            }
            else
            {
                <div class="qa-header">
                    <div class="col-expand"></div>
                    <div class="col-participant">@L["Participant"]</div>
                    <div class="col-worker">@L["Support Worker"]</div>
                    <div class="col-tenant">@L["Tenant"]</div>
                    <div class="col-commenced">@L["Assigned To"]</div>
                    <div class="col-submitted">@L["Submitted"]</div>
                    <div class="col-actions">@L["Actions"]</div>
                </div>

                @foreach (var enrolment in _pagedData.Items)
                {
                    <div class="qa-row mb-2">
                        <div class="col-expand">
                            <MudIconButton Icon="@(ExpandedRows.Contains(enrolment.Id) ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                                           Size="Size.Small"
                                           Edge="Edge.Start"
                                           OnClick="@(() => ToggleRow(enrolment.Id))"
                                           aria-label="Toggle notes" />
                        </div>

                        <div class="col-participant">
                            <MudText Typo="Typo.body2" Class="mb-0"><strong>@enrolment.ParticipantName</strong></MudText>
                            <MudText Typo="Typo.caption" Class="mt-0">@enrolment.ParticipantId</MudText>
                        </div>

                        <div class="col-worker">
                            <MudText Typo="Typo.body2">@enrolment.SupportWorker</MudText>
                        </div>

                        <div class="col-tenant">
                            <MudText Typo="Typo.body2">@enrolment.TenantName</MudText>
                            <MudText Typo="Typo.body2">@enrolment.TenantId</MudText>
                        </div>

                        <div class="col-assignedTo">
                            <MudText Typo="Typo.body2">@enrolment.AssignedTo</MudText>
                        </div>

                        <div class="col-submitted">
                            <MudText Typo="Typo.body2">@enrolment.Created.Date.ToString("d")</MudText>
                            <MudText Typo="Typo.caption">@enrolment.Created.Humanize()</MudText>
                        </div>

                        <div class="col-actions">
                            <MudMenu Dense="true" Icon="@Icons.Material.Filled.MoreVert" AnchorOrigin="Origin.CenterLeft">
                                <MudMenuItem OnClick="@(() => ViewParticipant(enrolment))">@ConstantString.ViewParticipant</MudMenuItem>
                            </MudMenu>
                        </div>
                    </div>

                    @if (ExpandedRows.Contains(enrolment.Id))
                    {
                        <div class="qa-expand">
                            <QaNotesDropdown ParticipantId=@enrolment.ParticipantId />
                        </div>
                    }
                }
                
                <div class="qa-pager-row">
                    <div class="qa-pager-right">
                        <MudText Typo="Typo.body2">Rows per page</MudText>
                        <MudSelect T="int"
                                   Value="@_defaultPageSize"
                                   ValueChanged="@(async v =>
                                                 {
                                                     _defaultPageSize = v;
                                                     await OnPaginationChanged(1);
                                                 })"
                                   Dense="true"
                                   Style="width: 70px;">
                            <MudSelectItem Value="10">10</MudSelectItem>
                            <MudSelectItem Value="15">15</MudSelectItem>
                            <MudSelectItem Value="30">30</MudSelectItem>
                            <MudSelectItem Value="50">50</MudSelectItem>
                        </MudSelect>

                        <MudText Typo="Typo.body2" Class="qa-page-counter">
                            Page @(_currentPage + 1) of @TotalPages
                        </MudText>

                        <MudPagination Count="@TotalPages"
                                       SelectedChanged="@(async p => await OnPaginationChanged(p))"
                                       ShowFirstButton="true"
                                       ShowLastButton="true"
                                       Style="display: inline-flex; width: auto;"/>
                    </div>
                </div>
            }
        </MudCardContent>
    </MudCard>
</CascadingValue>
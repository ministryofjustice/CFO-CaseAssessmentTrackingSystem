@page "/pages/qa/enrolments/qa1/"

@using Cfo.Cats.Application.Features.Documents.Queries
@using Cfo.Cats.Application.Features.Participants.DTOs
@using Cfo.Cats.Application.Features.Participants.Queries
@using Cfo.Cats.Application.Features.QualityAssurance.Commands
@using Cfo.Cats.Application.Features.QualityAssurance.DTOs
@using Cfo.Cats.Application.SecurityConstants
@using Cfo.Cats.Domain.Common.Enums

@inherits CatsComponentBase

@attribute [Authorize(Policy = SecurityPolicies.Qa1)]

<style>
    .document-container {
        width: 90%;
        height: calc(100vh - 150px);
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .full-size-object {
        width: 100%;
        height: 100%;
    }

    .mud-radio {
        display: block;
        margin-bottom: 0.5rem; 
    }
    
</style>
<MudContainer Style="width: 100%; min-width: 480px;" >
    <MudText Typo="Typo.h5" Class="mb-5">
        CFO Enrolment Queue First Pass
    </MudText>

    @if (_participantDto is null)
    {
        <MudButton OnClick="GetQueueItem" ButtonType="ButtonType.Button"
                   StartIcon="@Icons.Material.Filled.QueuePlayNext"
                   Variant="Variant.Outlined" Color="Color.Primary">
            Get Next
        </MudButton>
    }

    @if (_participantDto is not null && _participantDto.EnrolmentStatus == EnrolmentStatus.SubmittedToAuthorityStatus)
    {

    @if (_queueEntry!.IsAccepted)
    {
        <MudAlert Severity="Severity.Warning">
            This entry has already been processed
        </MudAlert>
    }

    <MudGrid Style="height: 100vh; width: 100vw;">
        <MudItem xs="4" Style="height: calc(100vh - 150px); width: 100%;">
            <MudText Typo="Typo.h2">
                Participant
            </MudText>

            <MudList T="string">
                <MudListItem T="string" Text="@_participantDto.Id"></MudListItem>
                <MudListItem T="string" Text="@_participantDto.FirstName"></MudListItem>
                <MudListItem T="string" Text="@_participantDto.LastName"></MudListItem>
                <MudListItem T="string" Text="@_participantDto.DateOfBirth.ToString()"></MudListItem>
                <MudListItem T="string" Text="@_participantDto.CurrentLocation.Name"></MudListItem>
            </MudList>

            <MudRadioGroup T="Guid" Class="mud-radio" ValueChanged="OnSelectedDocumentChanged">
                @foreach (var consent in _participantDto.Consents)
                {
                <MudRadio T="Guid" Color="Color.Primary" Value="@consent.DocumentId!.Value">
                    @consent.FileName
                </MudRadio>
                }

                @if (_participantDto.RightToWorks is [])
                {
                <MudRadio T="Guid" Color="Color.Primary" Disabled="true">
                    No right to work provided
                </MudRadio>
                }

                @foreach (var rtw in _participantDto.RightToWorks)
                {
                <MudRadio T="Guid" Color="Color.Primary" Value="@rtw.DocumentId!.Value">
                    @rtw.FileName
                </MudRadio>
                }
            </MudRadioGroup>

            @if (_queueEntry.IsCompleted == false)
            {
            <MudForm Model="@Command" @ref="_form" Validation="@(Validator.ValidateValue(Command))">
                <MudItem xs="12">
                    <MudRadioGroup T="bool?" @bind-Value="Command.Accept" For="@(() => Command.Accept)" Required="true">
                        <MudRadio T="bool?" Value="true" Color="Color.Primary">
                            Accept
                        </MudRadio>
                        <MudRadio T="bool?" Value="false" Color="Color.Secondary">
                            Return
                        </MudRadio>
                    </MudRadioGroup>
                </MudItem>

                <MudTextField @bind-Value="Command.Message" Label="Message" For="(() => Command.Message)" />
            </MudForm>
            <MudContainer Class="d-flex px-0 pt-8">
                <MudButton Color="Color.Primary" OnClick="SubmitToQa" Variant="Variant.Filled">Submit</MudButton>
            </MudContainer>

            }


        </MudItem>
        <MudItem xs="8" Style="height: 100%; width: 100%;">
            <MudPaper Class="document-container">
                @if (fileBase64 != null && extension!.Equals("pdf", StringComparison.CurrentCultureIgnoreCase))
                {
                <object data="data:application/pdf;base64,@fileBase64" type="application/pdf" class="full-size-object">
                    <p>PDF cannot be displayed.</p>
                </object>
                }
                else if(IsFileRejected)
                {
                <MudText Typo="Typo.caption">
                    File cannot be displayed. Please contact support.
                </MudText>
                }
                else
                {
                <MudText Typo="Typo.caption">
                    Please select a file to display
                </MudText>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
    }


</MudContainer>


@code {

    private MudForm? _form;
    private EnrolmentQueueEntryDto? _queueEntry = null;
    private ParticipantDto? _participantDto = null;

    private bool IsFileRejected {get; set;}
    
    [CascadingParameter]
    public UserProfile? UserProfile { get; set; } = null!;

    protected Guid SelectedDocument { get; set; } = Guid.Empty;

    private string? fileBase64;
    private string? extension;

    private SubmitQa1Response.Command Command { get; set; } = default!;

    private async Task GetQueueItem()
    {
        GrabQa1Entry.Command command = new GrabQa1Entry.Command()
        {
            CurrentUser = UserProfile!
        };

        var result = await GetNewMediator().Send(command);
        if (result.Succeeded)
        {
            _queueEntry = result.Data!;
            _participantDto = await GetNewMediator().Send(new GetParticipantById.Query()
            {
                Id = _queueEntry.ParticipantId
            });
            Command = new SubmitQa1Response.Command()
            {
                QueueEntryId = _queueEntry.Id,
                CurrentUser = UserProfile
            };
        }
        else
        {
            Snackbar.Add(result.ErrorMessage, Severity.Info);
        }

    }

    protected async Task SubmitToQa()
    {
        await _form!.Validate().ConfigureAwait(false);
        if (_form.IsValid)
        {
            var result = await GetNewMediator().Send(Command);

            if (result.Succeeded)
            {
                Snackbar.Add("Participant submitted to QA2", Severity.Info);
                Navigation.NavigateTo("/pages/qa/enrolments/qa1", true);
            }
            else
            {
                ShowActionFailure("Failed to submit", result);
            }
        }
       
    }
    
    private void ShowActionFailure(string title, IResult result)
    {
        Snackbar.Add(
        @<div>
            <h2>@title</h2>
            <ul>
                @foreach (var e in result.Errors)
                {
                    <li>@e</li>
                }
            </ul>
        </div>
        , Severity.Error, options => {
            options.RequireInteraction = true;
            options.SnackbarVariant = Variant.Text;
        } );
    }

    private async Task OnSelectedDocumentChanged(Guid documentId)
    {
        if (documentId != Guid.Empty)
        {
            var query = new GetDocumentById.Query()
            {
                Id = documentId
            };

            var result = await GetNewMediator().Send(query);

            if(result.Succeeded)
            {
                IsFileRejected = false;
                using (var memoryStream = new MemoryStream())
                {
                    await result.Data!.FileStream.CopyToAsync(memoryStream);
                    var bytes = memoryStream.ToArray();
                    fileBase64 = Convert.ToBase64String(bytes);
                }
                extension = result.Data!.FileExtension;
            }
            else 
            {
                IsFileRejected = true;
            }
        }
    }
}
name: Create new release

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to build from"
        required: true
        default: "develop"
        type: choice
        options:
          - develop
          - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout selected branch
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event.inputs.branch }}

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Restore
      run: dotnet restore ./cats.sln

    - name: Build
      run: dotnet build ./cats.sln --configuration Release --no-restore

    - name: Test
      run: dotnet test ./cats.sln --configuration Release --no-build --no-restore

    - name: Publish UI
      run: dotnet publish ./src/Server.UI/Server.UI.csproj --configuration Release --output ./artifacts/Server.UI --no-restore --no-build

    - name: Publish Migrations
      run: dotnet publish ./src/DatabaseMigrator/DatabaseMigrator.csproj --configuration Release --output ./artifacts/DatabaseMigrator --no-restore --no-build

    - name: Generate Version Tag
      id: version
      run: |
        DATE_TAG="v$(date +'%Y.%m.%d')-build.${{ github.run_number }}"
        BRANCH="${{ github.event.inputs.branch }}"

        if [ "$BRANCH" = "main" ]; then
          TAG_NAME="${DATE_TAG}"
        else
          TAG_NAME="${DATE_TAG}-dev"
        fi

        echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "Generated tag: $TAG_NAME"

    - name: Create Build Artifacts Archive
      run: |
        zip -r ${{ steps.version.outputs.tag }}.zip artifacts/Server.UI artifacts/DatabaseMigrator

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Release ${{ steps.version.outputs.tag }}
        files: |
          ${{ steps.version.outputs.tag }}.zip
        draft: false
        prerelease: ${{ github.event.inputs.branch != 'main' }}
        generate_release_notes: true
        fail_on_unmatched_files: true

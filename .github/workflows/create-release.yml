name: Create new release

on:
  workflow_dispatch:

jobs:
  build:
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Restore
      run: dotnet restore ./cats.sln

    - name: Build
      run: dotnet build ./cats.sln --configuration Release --no-restore

    - name: Test
      run: dotnet test ./cats.sln --configuration Release --no-build --no-restore

    - name: Publish UI
      run: dotnet publish ./src/Server.UI/Server.UI.csproj --configuration Release --output ./artifacts/Server.UI --no-restore --no-build

    - name: Publish Migrations
      run: dotnet publish ./src/DatabaseMigrator/DatabaseMigrator.csproj --configuration Release --output ./artifacts/DatabaseMigrator --no-restore --no-build

    - name: Generate Version Tag
      id: version
      run: |
        DATE_TAG="v$(date +'%Y.%m.%d')-build.${{ github.run_number }}"
        if [ "${GITHUB_REF##*/}" = "develop" ]; then
          TAG_NAME="${DATE_TAG}-dev"
        else
          TAG_NAME="${DATE_TAG}"
        fi
        echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "Generated tag: $TAG_NAME"

    - name: Create Build Artifacts Archive
      run: |
        cd artifacts
        zip -r ../../${{ steps.version.outputs.tag }}.zip Server.UI DatabaseMigrator

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Release ${{ steps.version.outputs.tag }}
        files: |
          ${{ steps.version.outputs.tag }}.zip
        draft: false
        prerelease: true
        generate_release_notes: true
        fail_on_unmatched_files: true

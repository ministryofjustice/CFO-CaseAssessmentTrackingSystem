name: Create new release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.2.3 or leave empty for auto-generated)'
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for proper versioning

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Restore
      run: dotnet restore ./

    - name: Build
      run: dotnet build ./cats.sln --configuration Release --no-restore

    - name: Test
      run: dotnet test ./ --configuration Release --no-build --no-restore

    - name: Publish UI
      run: dotnet publish ./src/Server.UI/Server.UI.csproj --configuration Release --output ./artifacts/publish/Server.UI --no-restore --no-build

    - name: Publish Migrations
      run: dotnet publish ./src/DatabaseMigrator/DatabaseMigrator.csproj --configuration Release --output ./artifacts/publish/DatabaseMigrator --no-restore --no-build 

    - name: Create Build Artifacts Archive
      run: |
        cd artifacts
        zip -r ../../Server.UI.zip ./Server.UI/*
        zip -r ../../DatabaseMigrator.zip ./DatabaseMigrator/*

    - name: Generate Version Tag
      id: version
      run: |
        if [ -n "${{ inputs.version }}" ]; then
          TAG_NAME="${{ inputs.version }}"
        else
          TAG_NAME="v$(date +'%Y.%m.%d')-build.${{ github.run_number }}"
        fi
        echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "Generated version: $TAG_NAME"

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Release ${{ steps.version.outputs.tag }}
        files: |
          Server.UI.zip
          DatabaseMigrator.zip
        draft: false
        prerelease: true
        generate_release_notes: true
        fail_on_unmatched_files: true